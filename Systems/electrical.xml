<?xml version="1.0" encoding="UTF-8"?>
<!--
	Electrical system for the P210N, by TheEagle, started in March 2022
	
	Technical data:
		Battery:
			Capacity: 12.75 Ah
			Voltage: 24 V
			Current: 60 (?) A
			Type: Lead-acid
		Alternator:
			Voltage: 28 V
			Current: 60 A
		Ground power:
			Voltage: 24 V
			Current 60 (?) A
		System:
			Voltage: 28 V
			Current: 60 A
			Type: Direct current
-->
<PropertyList>
	<!-- First, every supplier calculates it's avilable voltage and current -->
	<!-- Alternator -->
	<filter>
		<name>Available alternator amps</name>
		<type>gain</type>
		<gain>60</gain>
		<input>
			<expression>
				<div>
					<log>
						<!-- log gives negative values between 1 and 0, so offset the RPM by 1-->
						<sum>
							<property>/engines/engine/rpm</property>
							<value>1</value>
						</sum>
					</log>
					<!-- log 800 -->
					<value>6.68586094706836</value>
				</div>
			</expression>
		</input>
		<output>/systems/electrical/suppliers/alternator/available-amps</output>
		<min>0</min>
		<max>60</max>
	</filter>
	<filter>
		<name>Available alternator volts</name>
		<type>gain</type>
		<gain>0.035</gain>
		<input>/engines/engine/rpm</input>
		<output>/systems/electrical/suppliers/alternator/available-volts</output>
		<min>0</min>
		<max>28</max>
	</filter>
	
	<!-- Ground power -->
	<filter>
		<name>Available ground power amps</name>
		<type>gain</type>
		<gain>60</gain>
		<input>/controls/electrical/ground-power-connected</input>
		<output>/systems/electrical/suppliers/gpu/available-amps</output>
		<min>0</min>
		<max>60</max>
	</filter>
	<filter>
		<name>Available ground power volts</name>
		<type>gain</type>
		<gain>24</gain>
		<input>/controls/electrical/ground-power-connected</input>
		<output>/systems/electrical/suppliers/gpu/available-volts</output>
		<min>0</min>
		<max>24</max>
	</filter>
	
	<!-- Battery -->
	<filter>
		<!-- TODO: find a better formula - this is a simple polynomial that I just copied from the C182S,
			but the resulting curve looks quite different from an actual power-vs-charge curve of a lea-acid battery -->
		<name>Battery output factor based on charge</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<expression>
				<div>
					<sum>
						<pow>
							<prod>
								<dif>
									<prod>
										<value>3</value>
										<dif>
											<value>1</value>
											<property>/systems/electrical/suppliers/battery/charge-norm</property>
										</dif>
									</prod>
									<value>1</value>
								</dif>
								<value>-1</value>
							</prod>
							<value>5</value>
						</pow>
						<value>32</value>
					</sum>
					<value>32</value>
				</div>
			</expression>
		</input>
		<output>/systems/electrical/suppliers/battery/available-power-factor</output>
	</filter>
	<filter>
		<name>Available battery volts</name>
		<type>gain</type>
		<gain>/systems/electrical/suppliers/battery/available-power-factor</gain>
		<input>24</input>
		<output>/systems/electrical/suppliers/battery/available-volts</output>
	</filter>
	<filter>
		<name>Available battery amps</name>
		<type>gain</type>
		<gain>/systems/electrical/suppliers/battery/available-power-factor</gain>
		<input>60</input>
		<output>/systems/electrical/suppliers/battery/available-amps</output>
	</filter>
	
	<!-- Then, every supplier sets it's actual voltage and current based on the master switches -->
	<filter>
		<name>Alternator amps</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<condition>
				<and>
					<property>/controls/electric/battery-switch</property>
					<property>/controls/electric/engine[0]/master-alt</property>
				</and>
			</condition>
			<property>/systems/electrical/suppliers/alternator/available-amps</property>
		</input>
		<output>/systems/electrical/suppliers/alternator/amps</output>
	</filter>
	<filter>
		<name>Alternator volts</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<condition>
				<and>
					<property>/controls/electric/battery-switch</property>
					<property>/controls/electric/engine[0]/master-alt</property>
				</and>
			</condition>
			<property>/systems/electrical/suppliers/alternator/available-volts</property>
		</input>
		<output>/systems/electrical/suppliers/alternator/volts</output>
	</filter>
	
	<filter>
		<name>Ground power amps</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<condition>
				<property>/controls/electric/battery-switch</property>
			</condition>
			<property>/systems/electrical/suppliers/gpu/available-amps</property>
		</input>
		<output>/systems/electrical/suppliers/gpu/amps</output>
	</filter>
	<filter>
		<name>Ground power volts</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<condition>
				<property>/controls/electric/battery-switch</property>
			</condition>
			<property>/systems/electrical/suppliers/gpu/available-volts</property>
		</input>
		<output>/systems/electrical/suppliers/gpu/volts</output>
	</filter>
	
	<!-- Battery -->
	<filter>
		<name>Battery amps</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<condition>
				<property>/controls/electric/battery-switch</property>
			</condition>
			<property>/systems/electrical/suppliers/battery/available-amps</property>
		</input>
		<output>/systems/electrical/suppliers/battery/amps</output>
	</filter>
	<filter>
		<name>Battery volts</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<condition>
				<property>/controls/electric/battery-switch</property>
			</condition>
			<property>/systems/electrical/suppliers/battery/available-volts</property>
		</input>
		<output>/systems/electrical/suppliers/battery/volts</output>
	</filter>
	
	<!-- Some extra work for the battery: Charge / discharge the battery based on available / needed current -->
	<filter>
		<name>Apply battery input / output to charge</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<expression>
				<sum>
					<property>/systems/electrical/suppliers/battery/charge-amp_hours</property>
					<div>
						<dif>
							<max>
								<sum>
									<property>/systems/electrical/suppliers/alternator/amps</property>
									<property>/systems/electrical/suppliers/gpu/amps</property>
								</sum>
								<!-- most sources I found recommend charging a lead-acid battery at a quarter of their Ah rating -->
								<quotient>
									<property>/systems/electrical/suppliers/battery/capacity-amp_hours</property>
									<value>4</value>
								</quotient>
							</max>
							<property>/systems/electrical/suppliers/battery/output-amps</property>
						</dif>
						 <!-- Seconds of an hour (3600) * 120 Hz - that will empty the battery in one hour if discharged at it's Ah rating -->
						<value>432000</value>
					</div>
				</sum>
			</expression>
		</input>
		<output>/systems/electrical/suppliers/battery/charge-amp_hours</output>
		<min>0</min>
		<max>/systems/electrical/suppliers/battery/capacity-amp_hours</max>
	</filter>
	<filter>
		<name>Battery charge normalized</name>
		<type>gain</type>
		<gain>1</gain>
		<input>
			<expression>
				<div>
					<property>/systems/electrical/suppliers/battery/charge-amp_hours</property>
					<property>/systems/electrical/suppliers/battery/capacity-amp_hours</property>
				</div>
			</expression>
		</input>
		<output>/systems/electrical/suppliers/battery/charge-norm</output>
	</filter>
	<filter>
		<name>Battery charge percent</name>
		<type>gain</type>
		<gain>100</gain>
		<input>/systems/electrical/suppliers/battery/charge-norm</input>
		<output>/systems/electrical/suppliers/battery/charge-percent</output>
	</filter>
	
	<logic>
		<name>Determine if battery is supplying power</name>
		<input>
			<condition>
				<greater-than>
					<property>/systems/electrical/suppliers/battery/volts</property>
					<value>12</value>
				</greater-than>
			</condition>
		</input>
		<output>/systems/electrical/suppliers/battery/power</output>
	</logic>
	<logic>
		<name>Determine if alternator is supplying power</name>
		<input>
			<condition>
				<greater-than>
					<property>/systems/electrical/suppliers/alternator/volts</property>
					<property>/systems/electrical/suppliers/battery/volts</property>
				</greater-than>
			</condition>
		</input>
		<output>/systems/electrical/suppliers/alternator/power</output>
	</logic>
	<logic>
		<name>Determine if ground power receptacle is supplying power</name>
		<input>
			<condition>
				<greater-than>
					<property>/systems/electrical/suppliers/gpu/volts</property>
					<expression>
						<max>
							<property>/systems/electrical/suppliers/alternator/volts</property>
							<property>/systems/electrical/suppliers/battery/volts</property>
						</max>
					</expression>
				</greater-than>
			</condition>
		</input>
		<output>/systems/electrical/suppliers/gpu/power</output>
	</logic>
</PropertyList>
